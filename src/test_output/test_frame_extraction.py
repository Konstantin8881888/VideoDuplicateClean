import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

from src.core.frame_extractor import FrameExtractor


def get_video_path_from_user():
    """–ü–æ–ª—É—á–∞–µ—Ç –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ—Ñ–∞–π–ª—É –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏"""
    while True:
        print("\n" + "=" * 50)
        print("–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∏–¥–µ–æ—Ñ–∞–π–ª—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        print("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .mp4, .avi, .mov, .mkv, .wmv")
        print("–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞")
        print("=" * 50)

        user_input = input("–ü—É—Ç—å –∫ –≤–∏–¥–µ–æ—Ñ–∞–π–ª—É: ").strip()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–π—Ç–∏
        if user_input.lower() in ['q', 'quit', 'exit']:
            return None

        # –û—á–∏—â–∞–µ–º –ø—É—Ç—å –æ—Ç –∫–∞–≤—ã—á–µ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        cleaned_path = user_input.strip('"\'')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
        if not os.path.exists(cleaned_path):
            print(f"‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {cleaned_path}")
            print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:")
            print("1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —É–∫–∞–∑–∞–Ω –ø—É—Ç—å")
            print("2. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª")
            print("3. –ù–µ—Ç –ª–∏ –æ–ø–µ—á–∞—Ç–æ–∫ –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞")
            continue

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Ñ–∞–π–ª, –∞ –Ω–µ –ø–∞–ø–∫–∞
        if not os.path.isfile(cleaned_path):
            print(f"‚ùå –û–®–ò–ë–ö–ê: –≠—Ç–æ –ø–∞–ø–∫–∞, –∞ –Ω–µ —Ñ–∞–π–ª: {cleaned_path}")
            continue

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        file_ext = os.path.splitext(cleaned_path)[1].lower()
        supported_formats = {'.mp4', '.avi', '.mov', '.mkv', '.wmv'}

        if file_ext not in supported_formats:
            print(f"‚ùå –û–®–ò–ë–ö–ê: –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: {file_ext}")
            print(f"‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: {', '.join(supported_formats)}")
            continue

        # –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        print(f"‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω: {cleaned_path}")
        return cleaned_path


def suggest_common_locations():
    """–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ–∏—Å–∫–∞ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤"""
    common_locations = [
        os.path.expanduser("~/Videos"),
        os.path.expanduser("~/Downloads"),
        "D:/",
        "C:/Users/Public/Videos",
        "C:/Videos",
    ]

    print("\nüí° –°–æ–≤–µ—Ç: –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∏—Å–∫–∞—Ç—å –≤–∏–¥–µ–æ—Ñ–∞–π–ª—ã –≤ —ç—Ç–∏—Ö –ø–∞–ø–∫–∞—Ö:")
    for location in common_locations:
        if os.path.exists(location):
            print(f"   üìÅ {location}")


def test_frame_extraction():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤"""
    print("üé¨ VideoDuplicate Cleaner - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤")

    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä FrameExtractor
    extractor = FrameExtractor()

    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    video_path = get_video_path_from_user()

    if not video_path:
        print("üëã –í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã.")
        suggest_common_locations()
        return

    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
        print("\nüìä –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ...")
        video_info = extractor.get_video_info(video_path)

        if not video_info:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–µ")
            print("–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
            print("1. –§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω")
            print("2. –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∫–æ–¥–µ–∫")
            print("3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞")
            return

        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
        print("‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ:")
        print(f"   üìè –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: {video_info.get('width')}x{video_info.get('height')}")
        print(f"   ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {video_info.get('duration', 0):.1f} —Å–µ–∫—É–Ω–¥")
        print(f"   üéûÔ∏è FPS: {video_info.get('fps', 0):.1f}")
        print(f"   üñºÔ∏è –í—Å–µ–≥–æ –∫–∞–¥—Ä–æ–≤: {video_info.get('total_frames', 0)}")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–¥—Ä—ã
        print("\nüéØ –ò–∑–≤–ª–µ–∫–∞–µ–º 10 –∫–∞–¥—Ä–æ–≤...")
        frames = extractor.extract_frames(video_path, 10)

        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–æ –∫–∞–¥—Ä–æ–≤: {len(frames)}")

        if frames:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–≤–æ–º –∫–∞–¥—Ä–µ
            first_frame = frames[0]
            print(f"üìê –†–∞–∑–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ –∫–∞–¥—Ä–∞: {first_frame.shape}")

            # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–¥—Ä—ã
            print("\nüíæ –•–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏?")
            save_choice = input("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–¥—Ä—ã –≤ –ø–∞–ø–∫—É 'test_output'? (y/n): ").strip().lower()

            if save_choice == 'y':
                os.makedirs('test_output', exist_ok=True)
                saved_paths = extractor.extract_and_save_frames(video_path, 'test_output', 10)
                print(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(saved_paths)} –∫–∞–¥—Ä–æ–≤ –≤ –ø–∞–ø–∫—É 'test_output'")
                print("üìÅ –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É 'test_output' —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã")

            # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª
            print("\nüîÑ –•–æ—Ç–∏—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –≤–∏–¥–µ–æ—Ñ–∞–π–ª?")
            another_test = input("–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª? (y/n): ").strip().lower()
            if another_test == 'y':
                test_frame_extraction()
            else:
                print("üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        else:
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞")
            suggest_common_locations()

    except Exception as e:
        print(f"üí• –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –æ–± —ç—Ç–æ–π –æ—à–∏–±–∫–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º")


def quick_test():
    """–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç —Å –ø—Ä–∏–º–µ—Ä–æ–º –ø—É—Ç–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)"""
    print("\n‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)")

    # –ü—Ä–∏–º–µ—Ä –ø—É—Ç–∏ - –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    # test_path = r"D:\example\test_video.mp4"

    # –ù–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥
    test_path = input("–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø—É—Ç—å: ").strip('"\'')

    if test_path and os.path.exists(test_path):
        extractor = FrameExtractor()
        frames = extractor.extract_frames(test_path, 3)
        print(f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(frames)} –∫–∞–¥—Ä–æ–≤")
    else:
        print("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")


if __name__ == "__main__":
    # –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç
    test_frame_extraction()